// Lakh MIDI Dataset - Data Vault Lite Schema
// Simplified for static dataset - keeps relationship modeling, drops temporal complexity

// =============================================================================
// HUBS - Business Keys (Keep full DV structure for referential integrity)
// =============================================================================

Table hub_track {
  track_hk varchar [pk, note: 'Hash key for track']
  track_id varchar [not null, unique, note: 'MusicBrainz track ID (business key)']
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null, note: 'lmd_h5 | match_scores | derived']
}

Table hub_midi_file {
  midi_hk varchar [pk, note: 'Hash key for MIDI file']
  midi_md5 varchar [not null, unique, note: 'MIDI file MD5 hash (business key)']
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null, note: 'md5_paths | lmd_full | derived']
}

Table hub_artist {
  artist_hk varchar [pk, note: 'Hash key for artist']
  artist_id varchar [not null, unique, note: 'Echo Nest/MusicBrainz artist ID (business key)']
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
}

Table hub_release {
  release_hk varchar [pk, note: 'Hash key for release']
  release_id varchar [not null, unique, note: 'Release identifier (business key)']
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
}

Table hub_midi_source {
  source_hk varchar [pk, note: 'Hash key for MIDI source']
  source_path varchar [not null, unique, note: 'Source path (business key)']
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null, note: 'md5_to_paths.json']
}

Table hub_key_signature {
  key_signature_hk varchar [pk, note: 'Hash key for key signature']
  key_signature_id integer [not null, unique, note: '0-11 where 0=C (business key)']
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null, note: 'ref_key_signatures']
}

Table hub_mode {
  mode_hk varchar [pk, note: 'Hash key for mode']
  mode_id integer [not null, unique, note: '0=minor, 1=major (business key)']
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null, note: 'ref_modes']
}

// =============================================================================
// LINKS - Relationships (Keep DV structure - this is the main value)
// =============================================================================

Table link_track_midi {
  link_track_midi_hk varchar [pk, note: 'Hash key for track-MIDI relationship']
  track_hk varchar [not null, ref: > hub_track.track_hk]
  midi_hk varchar [not null, ref: > hub_midi_file.midi_hk]
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null, note: 'match_scores | manual | derived']
  
  indexes {
    (track_hk, midi_hk) [unique]
  }
}

Table link_track_artist {
  link_track_artist_hk varchar [pk]
  track_hk varchar [not null, ref: > hub_track.track_hk]
  artist_hk varchar [not null, ref: > hub_artist.artist_hk]
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
  
  indexes {
    (track_hk, artist_hk) [unique]
  }
}

Table link_track_release {
  link_track_release_hk varchar [pk]
  track_hk varchar [not null, ref: > hub_track.track_hk]
  release_hk varchar [not null, ref: > hub_release.release_hk]
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
  
  indexes {
    (track_hk, release_hk) [unique]
  }
}

Table link_artist_similar {
  link_artist_similar_hk varchar [pk]
  artist_hk varchar [not null, ref: > hub_artist.artist_hk]
  similar_artist_hk varchar [not null, ref: > hub_artist.artist_hk]
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
  
  indexes {
    (artist_hk, similar_artist_hk) [unique]
  }
}

Table link_midi_source {
  link_midi_source_hk varchar [pk, note: 'Hash key for MIDI-source relationship']
  midi_hk varchar [not null, ref: > hub_midi_file.midi_hk]
  source_hk varchar [not null, ref: > hub_midi_source.source_hk]
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null, note: 'md5_to_paths.json']
  
  indexes {
    (midi_hk, source_hk) [unique]
  }
}


// =============================================================================
// SATELLITES - Descriptive attributes for hubs
// =============================================================================

Table sat_track {
  track_hk varchar [pk, ref: > hub_track.track_hk]
  
  // Audio analysis data
  audio_md5 varchar
  analysis_sample_rate integer
  danceability float
  duration float
  end_of_fade_in float
  energy float
  key_signature_id integer
  key_confidence float
  loudness float
  mode_id integer
  mode_confidence float
  start_of_fade_out float
  tempo float
  time_signature integer
  time_signature_confidence float
  
  // Metadata
  title varchar
  genre varchar
  year integer
  analyzer_version varchar
  song_id varchar [note: 'Echo Nest song ID']
  song_hotttnesss float
  
  // Index references for time series data
  idx_bars_confidence integer
  idx_bars_start integer
  idx_beats_confidence integer
  idx_beats_start integer
  idx_sections_confidence integer
  idx_sections_start integer
  idx_segments_confidence integer
  idx_segments_loudness_max integer
  idx_segments_loudness_max_time integer
  idx_segments_loudness_start integer
  idx_segments_pitches integer
  idx_segments_start integer
  idx_segments_timbre integer
  idx_tatums_confidence integer
  idx_tatums_start integer
  idx_artist_terms integer
  idx_similar_artists integer
  idx_artist_mbtags integer
  
  // Bars analysis
  bars_start float[] [note: 'Array of bar start times']
  bars_confidence float[] [note: 'Array of bar confidence scores']
  
  // Beats analysis  
  beats_start float[] [note: 'Array of beat start times']
  beats_confidence float[] [note: 'Array of beat confidence scores']
  
  // Sections analysis
  sections_start float[] [note: 'Array of section start times']
  sections_confidence float[] [note: 'Array of section confidence scores']
  
  // Segments analysis (most detailed)
  segments_start float[] [note: 'Array of segment start times']
  segments_confidence float[] [note: 'Array of segment confidence scores']
  segments_loudness_max float[] [note: 'Array of segment max loudness values']
  segments_loudness_max_time float[] [note: 'Array of times when max loudness occurs']
  segments_loudness_start float[] [note: 'Array of segment start loudness values']
  segments_pitches float[][] [note: 'Array of 12-element pitch vectors per segment']
  segments_timbre float[][] [note: 'Array of 12-element timbre vectors per segment']
  
  // Tatums analysis (finest rhythmic unit)
  tatums_start float[] [note: 'Array of tatum start times']
  tatums_confidence float[] [note: 'Array of tatum confidence scores']
  
  
  // Audit fields
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
}

Table sat_artist {
  artist_hk varchar [pk, ref: > hub_artist.artist_hk]
  
  artist_name varchar
  artist_mbid varchar [note: 'MusicBrainz artist ID']
  artist_familiarity float
  artist_hotttnesss float
  artist_latitude float
  artist_longitude float
  artist_location varchar
  artist_7digitalid integer
  artist_playmeid integer
  
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
}

Table sat_release {
  release_hk varchar [pk, ref: > hub_release.release_hk]
  
  release varchar
  release_7digitalid integer
  track_7digitalid integer
  
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
}

Table sat_midi_file {
  midi_hk varchar [pk, ref: > hub_midi_file.midi_hk]
  
  file_content bytea [note: 'Raw MIDI file bytes']
  file_size integer
  
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
}

Table sat_key_signature {
  key_signature_hk varchar [pk, ref: > hub_key_signature.key_signature_hk]
  
  key_name varchar [not null, note: 'C, C#/Db, D, etc.']
  
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
}

Table sat_mode {
  mode_hk varchar [pk, ref: > hub_mode.mode_hk]
  
  mode_name varchar [not null, note: 'minor, major']
  
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
}


// =============================================================================
// LINK SATELLITES - Descriptive attributes for links
// =============================================================================

Table sat_match_scores {
  link_track_midi_hk varchar [pk, ref: > link_track_midi.link_track_midi_hk]
  
  score float [note: 'Matching confidence score (0-1)']
  matching_algorithm varchar [note: 'Algorithm used for matching']
  
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
}

Table sat_artist_similarity {
  link_artist_similar_hk varchar [pk, ref: > link_artist_similar.link_artist_similar_hk]
  
  similarity_rank integer [note: 'Order of similarity (1=most similar)']
  similarity_score float [note: 'Computed similarity score if available']
  
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
}


// =============================================================================
// MULTI-ACTIVE SATELLITES - Many-to-many descriptive data
// =============================================================================

Table sat_artist_terms {
  artist_hk varchar [not null, ref: > hub_artist.artist_hk]
  term varchar [not null]
  frequency float
  weight float
  term_rank integer [note: 'Rank order for this artist']
  
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
  
  indexes {
    (artist_hk, term) [pk]
  }
}

Table sat_artist_mbtags {
  artist_hk varchar [not null, ref: > hub_artist.artist_hk]
  tag varchar [not null]
  tag_count integer
  tag_rank integer [note: 'Rank order for this artist']
  
  load_date timestamp [not null, default: `now()`]
  record_source varchar [not null]
  
  indexes {
    (artist_hk, tag) [pk]
  }
}